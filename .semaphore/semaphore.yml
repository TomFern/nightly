version: v1.0
name: Operately â€” Nightly Build
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Version
    task:
      jobs:
        - name: Calculate Version
          commands:
            - 'git clone https://github.com/operately/operately.git'
            - cd operately
            - echo "nightly-build-$(date +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)" > version
            - artifact push workflow version
  - name: Docker Image
    task:
      jobs:
        - name: Build Docker Image
          commands:
            - checkout 
            - sudo bash enable-docker-containerd
            - docker run --privileged --rm tonistiigi/binfmt --install all
            - 'git clone https://github.com/operately/operately.git'
            - cd operately
            - artifact pull workflow version
            - 'docker build -f Dockerfile.prod --platform linux/amd64,linux/arm64 -t operately/operately:$(cat version) .'
